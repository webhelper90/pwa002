name: Create PMTiles

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker
        uses: actions/setup-docker@v2

      - name: Build Docker image
        run: |
          docker build -t pmtiles-builder - << EOF
          FROM ubuntu:latest
          RUN apt-get update && apt-get install -y --no-install-recommends \
            osmconvert \
            tippecanoe \
            pmtiles \
            wget \
            && rm -rf /var/lib/apt/lists/*

          WORKDIR /app
          COPY . .
          EOF

      - name: Run Docker container
        run: |
          docker run --rm -v $(pwd):/app pmtiles-builder bash -c "wget -O tohoku-latest.osm.pbf $(curl -s https://download.geofabrik.de/asia/japan/tohoku.html | grep -oP 'href='\Kasia/japan/tohoku-latest\.osm\.pbf(?=')) && tippecanoe -f -o=tohoku.mbtiles -z14 -l osm tohoku-latest.osm.pbf && pmtiles convert tohoku.mbtiles tohoku.pmtiles"

      - name: Upload PMTiles artifact
        uses: actions/upload-artifact@v3
        with:
          name: tohoku-pmtiles
          path: tohoku.pmtiles
